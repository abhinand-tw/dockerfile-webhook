# Continuous delivery hook script

Скрипт обработки хука [webhook](https://github.com/adnanh/webhook) для [gitea](https://gitea.io/) и аналогов.

Предназначен для деплоя проектов, состоящего из следующих шагов:

* выгрузить проект из git
* добавить конфиг из KV-хранилища
* выполнить `make start-hook`

В зависимости от настроек и статуса проекта, эти шаги могут меняться. Подробнее описано в **Алгоритме работы**.

## Зависимости

* make - для выполнения целей Makefile (если этот файл есть в проекте)
* [enfist]() - KV-хранилище конфигураций проектов

## Требования к проекту

Для того, чтобы проект поддерживал деплой с помощью этого скрипта, он должен соответствовать следующим требованиям:

* Конфигурация проекта должна храниться в одном файле .env (имя можкт быть изменено в настройках), синтаксис которого совместим с docker-compose
* Для создания .env/старта/остановки/обновления должны использоваться цели .env/start-hook/stop/update (имена целей задаются в настройках хука и добавляются в файл .env)

## Установка

В настройках проекта (далее org/project) создать хук (тип: gitea) и указать в качестве адреса:

Если webhook сервер находится на удаленном хосте

https://cis.your_domain.net/hooks/remote?branch=default

Если webhook установлен на этом же хосте под управлением [dcape]()
(обмен с gitea будет происходить по внутренней сети dcape)
http://webhook:9000/hooks/local?branch=default

Параметр `branch=default` означает "взять ветку из переданного при вызове хука поля `ref`".
Если значение будет не `default`, при вызове хука будет выгружена указанная ветка (`git clone --depth=1 --recursive --branch $branch`)

ID (local/remote) соответствует имени конфигурации хука. Отличие конфигураций в установке переменной $ENV{MODE} в соответствующее ID значение (local/remote). 

## Алгоритм работы

1. Если $branch = 'default', взять значение из `ref`, отрезав префикс `refs/heads/`
2. Если $branch <> 'default' и $branch <> значение из `ref`, завершить работу
3. Если $branch имеет вид NAME-rm - выполнить **Удаление деплоя** и завершить работу
4. Определить каталог деплоя $dest (org--progect--branch)
5. Выгрузить из KV-store файл .env по ключу $dest
6. Если файл есть и в нем `_CI_HOOK_ENABLED=no` - завершить работу
7. Создать каталог деплоя $dest, если его нет
8. Если `_CI_HOOK_UPDATE_HOT=yes` - выполнить **Горячее обновление** и завершить работу
9. Выполнить **Холодное обновление**
10. Завершить работу

### Удаление деплоя

1. Удалить у $branch суффикс `-rm`
2. Определить каталог деплоя $dest (org--progect--branch)
3. Если $dest не существует - завершить работу
4. Выполнить в $dest `make $_CI_MAKE_STOP` (если есть Makefile)
5. Удалить $dest
6. Завершить работу

### Горячее обновление

1. **Подготовить .env**
2. Выполнить `git pull`
3. Выполнить `make $_CI_MAKE_UPDATE`

### Холодное обновление

1. Если есть $dest
  * Если есть Makefile - выполнить `make $_CI_MAKE_STOP`
  * Удалить $dest
2. Создать $dest
3. Выполнить `git clone`
4. **Подготовить .env**
5. Если в KV не было файла .env
  * Завершить работу
4. Если есть Makefile - выполнить `make $_CI_MAKE_START`

### Подготовка .env

1. Если в KV есть данные по ключу org--progect--branch - сохранить их в .env
2. Если нет данных
  * Выполнить `make .env`
  * Добавить в .env переменные `_CI_*`
  * Загрузить файл .env в KV
3. Выполнить `. .env`

